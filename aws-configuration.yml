# The AWSTemplateFormatVersion section (optional) identifies the capabilities of the template. The latest template format version is 2010-09-09 and is currently the only valid value.
AWSTemplateFormatVersion: '2010-09-09'
# For serverless applications (also referred to as Lambda-based applications), specifies the version of the AWS serverless Application Model (AWS SAM) to use.
Transform: AWS::Serverless-2016-10-31
# A text string that describes the template. This section must always follow the template format version section.
Description: Loose touch

# ======================================================================================================================
# Parameters.
Parameters:
  Stage:
    Description: Stage name (test, production...)
    Type: String
  Prefix:
    Description: Set a prefix for S3 buckets
    Type: String
  RootDomainName:
    Description: Domain name (example.com)
    Type: String

# ======================================================================================================================
# Specifies the stack resources and their properties, such as an Amazon Elastic Compute Cloud instance or an Amazon Simple Storage Service bucket.
# You can refer to resources in the Resources and Outputs sections of the template.
Resources:

  # ====================================================================================================================
  # Dynamo tables.
  LooseTouchTableUsers:
    Type: AWS::DynamoDB::Table                                                    # The AWS::DynamoDB::Table resource creates a DynamoDB table.
    Properties:
      AttributeDefinitions:                                                       # A list of attributes that describe the key schema for the table and indexes. Duplicates are allowed.
        - AttributeName: "ID"                                                     # ID.
          AttributeType: S                                                        # String.
        - AttributeName: "GOOGLE_USERNAME"                                        # Google username.
          AttributeType: S                                                        # String.
      BillingMode: PAY_PER_REQUEST                                                # Specify how you are charged for read and write throughput and how you manage capacity.
      GlobalSecondaryIndexes:                                                     # Global secondary indexes to be created on the table.
        - IndexName: "INDEX_GOOGLE_USERNAME"
          KeySchema:
            - AttributeName: "GOOGLE_USERNAME"
              KeyType: "HASH"
          Projection:                                                             # Attributes that are copied (projected) from the source table into the index.
            ProjectionType: "ALL"                                                 # The set of attributes that are projected into the index. KEYS_ONLY : Only the index and primary keys are projected into the index.
      TableName: "USERS"                                                          # A name for the table. If you don't specify a name, AWS CloudFormation generates a unique physical ID and uses that ID for the table name.
      KeySchema:                                                                  # Specifies the attributes that make up the primary key for the table.
        - AttributeName: "ID"
          KeyType: "HASH"

  LooseTouchTableContacts:
    Type: AWS::DynamoDB::Table                                                    # The AWS::DynamoDB::Table resource creates a DynamoDB table.
    Properties:
      AttributeDefinitions:                                                       # A list of attributes that describe the key schema for the table and indexes. Duplicates are allowed.
        - AttributeName: "USER_ID"                                                # ID.
          AttributeType: S                                                        # String.
        - AttributeName: "EMAIL"                                                  # Contact email.
          AttributeType: S                                                        # String.
        - AttributeName: "CONTACT_DUE_DATE"                                       # Contact due date.
          AttributeType: S                                                        # String.
      BillingMode: PAY_PER_REQUEST                                                # Specify how you are charged for read and write throughput and how you manage capacity.
      LocalSecondaryIndexes:                                                      # Local secondary indexes to be created on the table.
        - IndexName: "INDEX_CONTACT_DUE_DATE"
          KeySchema:
            - AttributeName: "USER_ID"
              KeyType: "HASH"
            - AttributeName: "CONTACT_DUE_DATE"
              KeyType: "RANGE"
          Projection:                                                             # Attributes that are copied (projected) from the source table into the index.
            ProjectionType: "ALL"                                                 # The set of attributes that are projected into the index. KEYS_ONLY : Only the index and primary keys are projected into the index.
      TableName: "CONTACTS"                                                       # A name for the table. If you don't specify a name, AWS CloudFormation generates a unique physical ID and uses that ID for the table name.
      KeySchema:                                                                  # Specifies the attributes that make up the primary key for the table.
        - AttributeName: "USER_ID"
          KeyType: "HASH"
        - AttributeName: "EMAIL"
          KeyType: "RANGE"

  # ====================================================================================================================
  # Defines available functions.
  LooseTouchFunction:
    # The resource type identifies the type of resource that you are declaring. https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html
    Type: AWS::Serverless::Function                                               # Creates a Lambda function, IAM execution role, and event source mappings which trigger the function.
    Properties:
      Handler: com.oakinvest.lt.configuration.StreamLambdaHandler::handleRequest  # Function within your code that is called to begin execution.
      Runtime: java8                                                              # The runtime environment.
      CodeUri: api/target/api-lambda-package.zip                                  # S3 Uri or location to the function code. The S3 object this Uri references MUST be a Lambda deployment package.
      MemorySize: 512                                                             # Size of the memory allocated per invocation of the function in MB. Defaults to 128.
      Policies: AWSLambdaBasicExecutionRole                                       # Names of AWS managed IAM policies or IAM policy documents or SAM Policy Templates that this function needs, which should be appended to the default role for this function.
      Timeout: 30                                                                 # Maximum time that the function can run before it is killed in seconds. Defaults to 3.
      Events:                                                                     # A map (string to Event source object) that defines the events that trigger this function.
        API:                                                                      # Event name.
          Type: Api                                                               # API Type.
          Properties:
            RestApiId: !Ref LooseTouchAPI                                         # Identifier of a RestApi resource which MUST contain an operation with the given path and method.
            Path: /{proxy+}                                                       # Configuring your resource as a proxy resource or {proxy+} is a greedy path wherein the entire sub-resource chain is passed to your backend as path variables.
            Method: any                                                           # HTTP method for which this function is invoked (POST, GET, DELETE, PUT...).

  # ====================================================================================================================
  # Defines API.
  LooseTouchAPI:
    Type: AWS::Serverless::Api                                                    # Creates a collection of Amazon API Gateway resources and methods that can be invoked through HTTPS endpoints.
    Properties:
      StageName: !Ref Stage                                                       # The name of the stage, which API Gateway uses as the first path segment in the invoke Uniform Resource Identifier (URI).
      Variables:
        Stage: !Ref Stage

  # ====================================================================================================================
  # Defines buckets for public website.
  LooseTouchWWWBucket:                                                           # The AWS::S3::Bucket resource creates an Amazon Simple Storage Service (Amazon S3) bucket in the same AWS Region where you create the AWS CloudFormation stack.
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Join                                                           # A name for the bucket. If you don't specify a name, AWS CloudFormation generates a unique physical ID and uses that ID for the bucket name.
        - ''
        - - !Ref Prefix
          - www.
          - !Ref RootDomainName
      AccessControl: PublicRead                                                   # A canned access control list (ACL) that grants predefined permissions to the bucket.
      WebsiteConfiguration:                                                       # Information used to configure the bucket as a static website. For more information
        IndexDocument: index.html                                                 # The name of the index document for the website.
        ErrorDocument: 404.html                                                   # The name of the error document for the website.

  LooseTouchRootBucket:
    Type: AWS::S3::Bucket                                                         # The AWS::S3::Bucket resource creates an Amazon Simple Storage Service (Amazon S3) bucket in the same AWS Region where you create the AWS CloudFormation stack.
    Properties:
      BucketName: !Join                                                           # A name for the bucket. If you don't specify a name, AWS CloudFormation generates a unique physical ID and uses that ID for the bucket name.
        - ''
        - - !Ref Prefix
          - .
          - !Ref RootDomainName
      AccessControl: BucketOwnerFullControl                                       # A canned access control list (ACL) that grants predefined permissions to the bucket.
      WebsiteConfiguration:                                                       # Information used to configure the bucket as a static website. For more information
        RedirectAllRequestsTo:                                                    # The RedirectAllRequestsTo code is an embedded property of the Amazon S3 Website Configuration Property property that describes the redirect behavior of all requests to a website endpoint of an Amazon S3 bucket.
          HostName: !Ref LooseTouchRootBucket                                     # Name of the host where requests are redirected.

  # ====================================================================================================================
  # Defines DNS.
  LooseTouchDNS:
    Type: AWS::Route53::RecordSetGroup
    Properties:
      HostedZoneName: !Sub
        - ${Domain}.
        - Domain: !Ref RootDomainName
      Comment: Zone apex alias.
      RecordSets:
        - Name: !Ref RootDomainName
          Type: A
          AliasTarget:
            HostedZoneId: Z3KY65QIEKYHQQ
            DNSName: s3-website-us-west-3.amazonaws.com
        - Name: !Sub
            - www.${Domain}
            - Domain: !Ref RootDomainName
          Type: CNAME
          TTL: 900
          ResourceRecords:
            - !GetAtt LooseTouchWWWBucket.DomainName

# ======================================================================================================================
# Describes the values that are returned whenever you view your stack's properties.
# For example, you can declare an output for an S3 bucket name and then call the aws cloudformation describe-stacks AWS CLI command to view the name.
Outputs:

  # ====================================================================================================================
  # URL of API.
  APIURL:
    Description: API URL
    Value: !Join
      - ''
      - - 'https://'
        - !Ref LooseTouchAPI
        - '.execute-api.'
        - !Ref 'AWS::Region'
        - '.amazonaws.com/'
        - !Ref Stage

  # ====================================================================================================================
  # URL of the S3 bucket.
  WWWURL:
    Description: S3 bucket holding website content URL
    Value: !Join
      - ''
      - - 'http://'
        - !Ref LooseTouchRootBucket
        - '.s3-website.'
        - !Ref 'AWS::Region'
        - '.amazonaws.com'